---
title: "US Migration Policy Script"
author: "Amber Lee"
date: "1/8/2020"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven) # For reading stata file
library(tidyverse) # Primarily for dplyr, data manipulation, and pipe  %>% function
library(mclust) # Gaussian finite mixture models
library(knitr) 

cbPalette <- c("#0072B2", "#D55E00", "#CC79A7", "#E69F00", "#56B4E9") #For ggplot
```

# Introduction

```{r Read and clean data, message=FALSE, echo=FALSE, warning=FALSE}

#Create "demig" dataframe, a dataset recording global migration policies
demig <- read_dta("demig.dta")

#Convert haven labelled values to characters
demig <- as_factor(demig, levels = c("default", "labels", "values", "both"), ordered = FALSE)

#Clean demig data for 1950-onwards US policy with assessable and applicable changes in restrictiveness
demigUS1950 %>% dplyr::filter(demig, demig$country == "United States of America", year >= 1950, change_restrict != "Non applicable" & change_restrict != "Cannot be assessed"  & change_level != "Non applicable" & change_level != "Cannot be assessed")

```

# Initial data exploration: descriptive results

## Restrictiveness and policy areas
```{r Restrictiveness and policy area, include = FALSE}

#Plot restrictiveness levels , color-coded by policy area
ggplot(data = demigUS1950) +
  geom_bar(mapping = aes(x = change_restrict, fill = pol_area), position = "dodge") +
  labs(
    title = "Restrictiveness levels correspond to different policy areas",
    x = "Restrictiveness level",
    y = "Policy count",
    fill = "Policy area"
  )

#Create contingency table for different levels of restrictiveness and policy area
restrictiveness_by_policy_area <- column_to_rownames(spread(tally(group_by(demigUS1950, pol_area, change_restrict)), key = change_restrict, value = n), var = "pol_area")

#Reset grouping
demigUS1950 <- ungroup(demigUS1950, pol_area)

#Fill in empty values with 0
restrictiveness_by_policy_area[is.na(restrictiveness_by_policy_area)] <- 0
```

## Restrictiveness and change level

```{r Restrictiveness and change level, include = FALSE}

#Plot restrictiveness levels, color-coded by change level
ggplot(data = demigUS1950) +
  geom_bar(mapping = aes(x = change_restrict, fill = change_level), position = "dodge") +
  scale_fill_manual(values=cbPalette) +
  labs(
    title = "Restrictiveness levels also correspond to different change levels",
    subtitle = "Twice as many mid-level less restrictive changes than mid-level more restrictive changes.",
    x = "Restrictiveness levels",
    y = "Policy count",
    fill = "Change level of policies"
  )
```

## Restrictiveness and target groups

```{r Restrictiveness and target groups, include = FALSE}

#Create truncated labels for target groups
target_group_labels = rev(c("Specific categories", "Refugees, asylum seekers, other vulnerable people", "Irregular migrants", "Investors, entreprenuers, business people", "International students", "Family members of refugees", "Family members of high-skilled workers", "Family members", "Skilled/high-skilled workers", "Low-skilled workers", "All migrant workers", "All migrants", "All"))

#Plot restrictiveness for different target groups
ggplot(data = demigUS1950) +
  geom_bar(mapping = aes(x = target_group, fill = change_restrict), width = .8) +
  coord_flip() +
  scale_fill_manual(values=cbPalette) +
  labs(
    title = "Different target groups experience different restrictiveness levels",
    subtitle = "High- and low-skilled workers regulated in opposite ways,\nand refugees are the most regulated group",
    x = "Target group",
    y = "Policy count",
    fill = "Change level of policies"
  ) +
  theme(legend.position = "bottom") +
  scale_x_discrete(labels = target_group_labels)

#Create contingency table for different levels of restrictiveness and target groups
restrictiveness_by_target_group <- column_to_rownames(spread(tally(group_by(demigUS1950, target_group, change_restrict)), key = "change_restrict", value = n), var = "target_group")
restrictiveness_by_target_group[is.na(restrictiveness_by_target_group)] <- 0
head(restrictiveness_by_target_group) 
```

## Restrictiveness of policy areas through time 

```{r Restrictiveness of policy areas through time, include = FALSE}

#Plot restrictiveness levels per year by policy area
ggplot(data = demigUS1950) +
  geom_bar(mapping =  aes(x =year, fill = change_restrict)) +
  facet_wrap(~ pol_area, nrow = 5) +
  scale_fill_manual(values=cbPalette) +
  labs(
    title = "Restrictiveness of policy areas through time",
    x = "Year",
    y = "Policy count",
    fill = "Restrictiveness of policy"
  )
```

# Creating a new variable: magnitude score

```{r Create variable and key}

#Recode change_level and change_restrict to be numeric
demigUS1950$numeric_change_restrict <- as.numeric(demigUS1950$change_restrict)
demigUS1950$numeric_change_level <- as.numeric(demigUS1950$change_level)

#Re-code restrictiveness level to be -1, 0, 1 for more, no change, and less restrictive
demigUS1950 <- dplyr::mutate(demigUS1950, numeric_change_restrict = (numeric_change_restrict - 2))

#Create keys for reference
key_change_level <- tibble(numeric_change_level = c('Fine-tune', 'Minor', 'Mid-level', 'Major'), number = c(1, 2, 3, 4))
key_change_level

key_change_restrict <- tibble(numeric_change_restrictive = c('Less restrictive', 'No change', 'More restrictive'), number = c(-1, 0, 1))
key_change_restrict

#Create new variable, magnitude score -- the product of numeric change levels and restrictiveness
demigUS1950 <- demigUS1950 %>% 
  group_by(year) %>%
  dplyr::mutate(mag_score = numeric_change_restrict * numeric_change_level)

#View demigUS1950, seeing how mag_score combines change_restrict and change_level information
head(select(demigUS1950, year, mag_score, change_restrict, change_level))
```

## Magnitude scores distribution

```{r}
#Plot magnitude scores distribution
ggplot(data=dplyr::filter(demigUS1950)) +
  geom_bar(mapping = aes(x = mag_score)) +
  labs(
    title = "Distribution of all magnitude scores",
    x = "Magnitude score",
    y = "Number of policies"
  )
```

# Further analysis of magnitude scores

## Magnitude scores through time 

```{r Magnitude score through time}

#Plot magnitude scores through time
ggplot(data=dplyr::filter(demigUS1950, year >=1950), mapping = aes(x = year, y = mag_score)) +
  geom_smooth() +
  geom_point(position = "jitter") +
  geom_hline(yintercept=0, linetype = 3, color = "black") +
  labs(
    title = "Magnitude scores through time, all policies",
    x = "Year",
    y = "Magnitude score",
    fill = "Policy area"
  )

```

## Magnitude scores through time, disaggregated by policy area

```{r Disaggregate by policy area}

#Exclude Exit-related policies in the new graphs because there are too few of them to find meaningful results 
#Plot magnitude scores through time, categorizing by policy area
ggplot(data=dplyr::filter(demigUS1950, pol_area != "Exit"), mapping = aes(x = year, y = mag_score))+
  geom_smooth(mapping = aes(color = pol_area, fill = pol_area)) +
  geom_point(mapping = aes(color = pol_area), position = "jitter")  +
  geom_hline(yintercept=0, linetype = 3, color = "black") +
  labs(
    title = "Magnitude scores through time, by policy area",
    subtitle = "Excluding exit-related policies because there are too few of them",
    x = "Year",
    y = "Magnitude score",
    color = "Policy area",
    fill = "Policy area"
  )

#Same plot as before, but exclude integration-related policies because high variance
ggplot(data=dplyr::filter(demigUS1950, pol_area != "Exit", pol_area != "Integration"), mapping = aes(x = year, y = mag_score))+
  geom_smooth(mapping = aes(color = pol_area, fill = pol_area)) +
  geom_point(mapping = aes(color = pol_area), position = "jitter") +
  geom_hline(yintercept=0, linetype = 3, color = "black") +
  labs(
    title = "Magnitude scores through time, by policy area",
    subtitle = "Excluding integration-related policies because of high variance or few policies",
    x = "Year",
    y = "Magnitude score",
    color = "Policy area",
    fill = "Policy area"
  )
  
```

## Magnitude scores through time, disaggregated by policy area

```{r Distribution of magnitude scores for target groups}

#Plot distribution of magnitude scores, separated by different target groups
ggplot(data=dplyr::filter(demigUS1950, pol_area != "Exit")) +
  geom_bar(mapping = aes(x = mag_score)) +
  facet_wrap(~ target_group, ncol = 3) +
  labs(
    title = "Distribution of magnitude scores for different target groups",
    x = "Magnitude score",
    y = "Number of policies"
  )

#Same plot as before, but examine refugees and high-skilled workers in particular
ggplot(data=dplyr::filter(demigUS1950, pol_area != "Exit", target_group == "Skilled/high-skilled workers" | target_group == "Refugees, asylum seekers and other vulnerable people" | target_group == "All migrants"))+
  geom_bar(mapping = aes(x = mag_score)) +
  facet_wrap(~ target_group, ncol = 1) +
  labs(
    title = "Distribution of magnitude scores for selected target groups",
    subtitle = "Regulation for all migrants and refugees is bi-modal",
    x = "Magnitude score",
    y = "Number of policies"
  )

```

## Refugee-specific magnitude score analysis

```{r Refugees particularly}

#Exclude exit-related policies because too few
demigUS1950_ref <- demigUS1950 %>%
  dplyr::filter(pol_area != "Exit", target_group == "Refugees, asylum seekers and other vulnerable people")

#Plot magnitude scores of refugee migration policy through time
ggplot(data = demigUS1950_ref, mapping = aes(x = year, y = mag_score)) +
  geom_smooth() +
  geom_point(mapping = aes(color = pol_area), position = "jitter") +
  geom_hline(yintercept = 0, linetype = 3, color = "black") +
  labs(
    title = "Magnitude scores of refugee migration policy has become more restrictive recently",
    x = "Year",
    y = "Magnitude score"
  )

#Same plot as before, disaggregate by policy area
ggplot(data = demigUS1950_ref, mapping = aes(x = year, y = mag_score)) +
  geom_smooth(mapping = aes(color = pol_area, fill= pol_area)) +
  geom_point(mapping = aes(color = pol_area), position = "jitter") +
  geom_hline(yintercept = 0, linetype = 3, color = "black") +
  labs(
    title = "Magnitude scores of refugee migration policy by policy area",
    subtitle = "Legal entry and stay look to be driving the trend of more restrictive refugee policy",
    x = "Year",
    y = "Magnitude score"
  )
```

# Cluster analysis of magnitude score for refugee policy

```{r Mixture model}
#trying to use mclust. ungrouping demigUS1950 from year

refugee_mag_score <- demigUS1950 %>%
  ungroup() %>%
  dplyr::filter(target_group == "Refugees, asylum seekers and other vulnerable people") %>%
  select(mag_score)

mod1 = Mclust(refugee_mag_score)
summary(mod1)
mod2 = Mclust(refugee_mag_score, G = 2, modelnames=c(V))
summary(mod2,parameters=TRUE)
mod2$classification
#notice the variance (square of SD) -- so like 95% of "group 1" and 95% of "group 2" suggests that there are neutral/conservative stances against lax refugee policies, while there are a few extreme ardent supporters of refugee policy
```
